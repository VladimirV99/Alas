<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Butov Algoritam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script type="text/javascript" src="uoar_core.js"></script>
  <script type="text/javascript" src="type_converter.js"></script>
  <script type="text/javascript" src="output.js"></script>
  <script>

    function unsigned_multiply_wrapper(log=true) {
      var multiplicand = fromDecimal(toUOARNumber(document.getElementById('input_operand1').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var multiplier = fromDecimal(toUOARNumber(document.getElementById('input_operand2').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var solution = document.getElementById('solution');
      if(!solution.classList.contains('hidden'))
        solution.classList.add('hidden');
      clearOutput();
      clearStackTrace();
      var res = unsigned_multiply(multiplicand, multiplier, false, log);
      if(res!=null){
        solution.innerHTML=output;
        if(solution.classList.contains('hidden'))
          solution.classList.remove('hidden');
      }
      return res;
    }

    function unsigned_multiply(num1, num2, standardized=false, log=true){
      if(num1===null || num2===null || num1.base!=2 || num2.base!=2){
        addToStackTrace("unsigned_multiply", "Operands are invalid", log);
        return null;
      }
      if(getSignMultiplierForNumber(num1)!=1 || getSignMultiplierForNumber(num2)!=1){
        addToStackTrace("unsigned_multiply", "Operands must be positive", log);
        return null;
      }

      num1 = convertToType(trimSign(num1), NumberTypes.TC, standardized, log);
      num2 = convertToType(trimSign(num2), NumberTypes.TC, standardized, log);
      equalizeLength(num1, num2, true, log);
      var len = num1.sign.length + num1.whole.length + num1.fraction.length;

      var c = new UOARNumber("0", "", "", 2, NumberTypes.TC);
      var a = toLength(new UOARNumber("0", "0", "0", 2, NumberTypes.TC), len-1, num1.fraction.length);
      var m = num1;
      var p = num2;
      var registers = [c, a, p];

      addToOutput("<p>");
      addToOutput("M: (" + m.toSigned() + ")2<br>");
      addToOutput("P: (" + p.toSigned() + ")2");
      addToOutput("</p>");

      addToOutput("<table style=\"border: none;\">");
      addToOutput("<thead><tr><th>C</th><th>A</th><th>P</th><th>Komentar</th></tr></thead>");
      addToOutput("<tbody>");
      addToOutput("<tr><td>" + registers[0].toWhole() + "</td><td class=\"align-right\">" + registers[1].toWhole() + "</td><td>" + registers[2].toWhole() + "</td><td>Init</td></tr>");
      var work1 = "";
      var work2 = "";
      for(let im=0; im<len; im++){
        addToOutput("<tr>");
        
        op = registers[2].toWhole().charAt(registers[2].toWhole().length-1);
        work1 = "";
        work2 = "p0=" + op + " -> ";
        if(op=="0"){
          work2 = work2.concat("NOOP");
        }else if(op=="1"){
          registers[1] = add(registers[1], m, NumberTypes.TC, true, log);
          work1 = "+" + m.toWhole() + "<br>" + registers[1].toWhole() + "<br>";
          if(registers[1].whole.length>m.whole.length){
            registers[0].sign = registers[1].whole.charAt(0);
            registers[1].whole = registers[1].whole.substr(1);
          }
          work2 = work2.concat("A = A + M");
        }
        
        shift(registers, 1, ShiftTypes.RIGHT_L);
        work1 = work1.concat(registers[1].toWhole());

        addToOutput("<td>" + registers[0].toWhole() + "</td>");
        addToOutput("<td class=\"align-right\">" + work1 + "</td>");
        addToOutput("<td>" + registers[2].toWhole() + "</td>");
        addToOutput("<td>" + work2 + "</td>");
        addToOutput("</tr>");
      }
      addToOutput("</tbody>");
      addToOutput("</table>");

      addToOutput("<p>");
      addToOutput("AP = (" + registers[1].toWhole() + " " + registers[2].toWhole() + ")2<br>");
      var AP = registers[1].toWhole() + registers[2].toWhole();
      var AP_frac_len = 2 * num1.fraction.length;
      AP = AP.substr(0, AP.length-AP_frac_len) + "." + AP.substr(AP.length-AP_frac_len);
      var res = toUOARNumber(AP, 2, NumberTypes.TC, false);
      addToOutput("Rezultat: (" + res.toSigned() + ")2");
      addToOutput("</p>");
      return res;
    }

    function booth_wrapper(log=true) {
      var multiplicand = fromDecimal(toUOARNumber(document.getElementById('input_operand1').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var multiplier = fromDecimal(toUOARNumber(document.getElementById('input_operand2').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var solution = document.getElementById('solution');
      if(!solution.classList.contains('hidden'))
        solution.classList.add('hidden');
      clearOutput();
      clearStackTrace();
      var res = booth(multiplicand, multiplier, false, log);
      if(res!=null){
        solution.innerHTML=output;
        if(solution.classList.contains('hidden'))
          solution.classList.remove('hidden');
      }
      return res;
    }

    function booth(num1, num2, standardized=false, log=true){
      if(num1===null || num2===null || num1.base!=2 || num2.base!=2){
        addToStackTrace("booth", "Operands are not binary", log);
        return;
      }

      num1 = convertToType(trimSign(num1), NumberTypes.TC, standardized, log);
      num2 = convertToType(trimSign(num2), NumberTypes.TC, standardized, log);
      equalizeLength(num1, num2, true, log);
      var len = num1.sign.length + num1.whole.length + num1.fraction.length;

      var a = toLength(new UOARNumber("0", "0", "0", 2, NumberTypes.TC), len-1, num1.fraction.length);
      var m = num1;
      var neg_m = complement(num1);
      var p = num2;
      var p1 = new UOARNumber("0", "", "", 2, NumberTypes.TC);
      var registers = [a, p, p1];

      addToOutput("<p>");
      addToOutput("M: (" + m.toSigned() + ")2<br>");
      addToOutput("-M: (" + neg_m.toSigned() + ")2<br>");
      addToOutput("P: (" + p.toSigned() + ")2");
      addToOutput("</p>");

      addToOutput("<table style=\"border: none;\">");
      addToOutput("<thead><tr><th>A</th><th>P</th><th>P0</th><th>Komentar</th></tr></thead>");
      addToOutput("<tbody>");
      addToOutput("<tr><td class=\"align-right\">" + registers[0].toWhole() + "</td><td>" + registers[1].toWhole() + "</td><td>" + registers[2].toWhole() + "</td><td>Init</td></tr>");
      var work1 = "";
      var work2 = "";
      for(let im=0; im<len; im++){
        addToOutput("<tr>");
        
        op = registers[1].toWhole().charAt(registers[1].toWhole().length-1) + registers[2].toWhole();
        work1 = "";
        work2 = op + " -> ";
        if(op=="00" || op=="11"){
          work2 = work2.concat("NOOP");
        }else if(op=="10"){
          registers[0] = add(registers[0], neg_m, NumberTypes.TC, true, log);
          work1 = "+" + neg_m.toWhole() + "<br>" + registers[0].toWhole() + "<br>";
          work2 = work2.concat("A = A - M");
        }else if(op=="01"){
          registers[0] = add(registers[0], m, NumberTypes.TC, true, log);
          work1 = "+" + m.toWhole() + "<br>" + registers[0].toWhole() + "<br>";
          work2 = work2.concat("A = A + M"); 
        }
        
        shift(registers, 1, ShiftTypes.RIGHT_A);
        work1 = work1.concat(registers[0].toWhole());

        addToOutput("<td class=\"align-right\">" + work1 + "</td>");
        addToOutput("<td>" + registers[1].toWhole() + "</td>");
        addToOutput("<td>" + registers[2].toWhole() + "</td>");
        addToOutput("<td>" + work2 + "</td>");
        addToOutput("</tr>");
      }
      addToOutput("</tbody>");
      addToOutput("</table>");

      addToOutput("<p>");
      addToOutput("AP = (" + registers[0].toWhole() + " " + registers[1].toWhole() + ")2<br>");
      var AP = registers[0].toWhole() + registers[1].toWhole();
      var AP_frac_len = 2 * n1.fraction.length;
      AP = AP.substr(0, AP.length-AP_frac_len) + "." + AP.substr(AP.length-AP_frac_len);
      var res = toUOARNumber(AP, 2, NumberTypes.TC, false);
      addToOutput("Rezultat: (" + res.toSigned() + ")2");
      addToOutput("</p>");
      return res;
    }

    function modified_booth_wrapper(log=true) {
      var multiplicand = fromDecimal(toUOARNumber(document.getElementById('input_operand1').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var multiplier = fromDecimal(toUOARNumber(document.getElementById('input_operand2').value, 10, NumberTypes.SIGNED, false), 2, false, true);
      var solution = document.getElementById('solution');
      if(!solution.classList.contains('hidden'))
        solution.classList.add('hidden');
      clearOutput();
      clearStackTrace();
      var res = modified_booth(multiplicand, multiplier, false, log);
      if(res!=null){
        solution.innerHTML=output;
        if(solution.classList.contains('hidden'))
          solution.classList.remove('hidden');
      }
      return res;
    }

    function modified_booth(num1, num2, standardized=false, log=true){
      if(num1===null || num2===null || num1.base!=2 || num2.base!=2){
        addToStackTrace("modified_booth", "Operands are not binary", log);
        return;
      }

      num1 = convertToType(trimSign(num1), NumberTypes.TC, standardized, log);
      num2 = convertToType(trimSign(num2), NumberTypes.TC, standardized, log);
      if(num2.whole.length%2==1){
        wholeToLength(num2, num2.whole.length+1);
      }
      if(num1.sign!=num1.whole[0]){
        wholeToLength(num1, num1.whole.length+1);
      }
      wholeToLength(num1, 2*Math.max(num1.whole.length, num2.whole.length)-1);

      var work1 = "";
      var work2 = "";

      var mults = [];
      var last_char = "0";
      for(let i=num2.whole.length-1; i>=0; i--){
        work1 = "<td>" + num2.whole.charAt(i) + "</td>" + work1;
        if(num2.whole.charAt(i)==last_char){
          work2 = "<td>0</td>" + work2;
          mults.unshift(0);
        }else{
          if(num2.whole.charAt(i)=="1"){
            work2 = "<td>-1</td>" + work2;
            mults.unshift(-1);
          }else{
            work2 = "<td>+1</td>" + work2;
            mults.unshift(1);
          }
        }
        last_char = num2.whole.charAt(i);
      }
      addToOutput("<p>Kodirani mnozilac:<table style=\"border: none;\"><tbody><tr>"+work1+"</tr><tr>"+work2+"</tr></tbody></table></p>");

      var coded_mults = [];
      for(let i = 0; i<mults.length; i+=2){
        coded_mults.unshift(2*mults[i]+mults[i+1]);
      }

      var res = new UOARNumber("0", "0", "0", 2, NumberTypes.TC);
      var registers = [num1];

      addToOutput("<table style=\"border: none;\"");
      addToOutput("<thead><tr><th>k</th><th>v(k)</th><th>M<<2k</th><th>(M<<2k)v(k)</th></tr></thead>");
      addToOutput("<tbody>");
      for(let i = 0; i<coded_mults.length; i++){
        let temp = 1;
        let multiplier = registers[0].copy();
        console.log(multiplier);
        if(coded_mults[i]<0){
          multiplier = complement(multiplier);
          console.log(multiplier);
          temp = temp*-1;
        }
        if(coded_mults[i]==0){
          work1 = createZeroString(num1.whole.length);
        }else if(coded_mults[i]==temp){
          work1 = multiplier.toWhole();
          console.log(multiplier);
          res = add(res, multiplier, NumberTypes.TC, false);
        }else if(coded_mults[i]==2*temp){
          multiplier.whole = multiplier.whole.substr(1) + "0";
          work1 = multiplier.toWhole();
          console.log(multiplier);
          res = add(res, multiplier, NumberTypes.TC, false);
        }

        addToOutput("<tr>");
        addToOutput("<td>" + i + "</td>");
        addToOutput("<td>" + coded_mults[i] + "</td>");
        addToOutput("<td>" + registers[0].toWhole() + "</td>");
        addToOutput("<td>" + work1 + "</td>");
        addToOutput("</tr>");

        shift(registers, 2, ShiftTypes.LEFT);
      }
      addToOutput("</tbody>");
      addToOutput("</table>");

      addToOutput("<p>Rezultat: (" + res.toSigned() + ")2</p>");
      return res;
    }

  </script>
</head>
<body>

  <div class="titlebar">
    <h1 class="title">Aritmetika</h1>
    <a class="back" href="../index.html"><img src="../images/back.svg" alt="Back"></a>
  </div>

  <div class="info">
    <p>
      Skup algoritama za aritmeticke operacije. 
      Ukljucuje algoritam za neoznaceno mnozenje, Butov algoritam, modifikovani Butov algoritam, 
      algoritam za neoznaceno i oznaceno deljenje.
    </p>
  </div>

  <div class="container center" id="main">
    <table>
      <tr>
        <td><label for="input_operand1">1. operand:</label></td>
        <td><input type="text" id="input_operand1"></input></td>
      </tr>
      <tr>
        <td><label for="input_operand2">2. operand:</label></td>
        <td><input type="text" id="input_operand2"></input></td>
      </tr>
    </table>
    <input value="Neoznaceno mnozenje" type="button" name="unsigned_multiply" id="unsigned_multiply" class="button" onclick="unsigned_multiply_wrapper()"></input>
    <input value="Butov Algoritam" type="button" name="booth" id="booth" class="button" onclick="booth_wrapper()"></input>
    <input value="Modifikovani Butov Alg" type="button" name="modified_booth" id="modified_booth" class="button" onclick="modified_booth_wrapper()"></input>
  </div>
  
  <div class="container solution hidden" id="solution"></div>

</body>
</html>
 