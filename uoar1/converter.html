<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Konverter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="uoar_core.js"></script>
  <script type="text/javascript" src="output.js"></script>
  <script>

    function calculate(){
      var val = document.getElementById('input').value;
      var base1 = document.getElementById('base_src').value;
      var base2 = document.getElementById('base_dest').value;

      clearStackTrace();
      clearOutput();
      var res = convertBases(val, base1, base2, false, true);

      document.getElementById("text1").innerHTML=output;
    }

    function toDecimal(number, base, standardized=false, log=true){
      if(!isValidBase(base)){
        addToStackTrace("toDecimal", "Invalid base \"" + base + "\"");
        return null;
      }
      if(!standardized){
        number = standardizeNumber(number, base, log);
        if(number == null){
          addToStackTrace("toDecimal", "Invalid number \"" + number + "\" for base " + base, log);
          return null;
        }
      }
      if(base==10){
        return number;
      }
      var work1 = "";
      var work2 = "";
      addToOutput("(" + number + ")" + base + " = ");
      var temp;

      var radix = number.split(/[.,]/);
      var res = getSign(number, true);
      var num_length = radix[0].length-1;
      var decimal = 0;
      var i = 0;
      while(num_length>0){
        temp = getValueAt(radix[0], i+1, log);
        work1 = work1.concat(temp + "*" + base + "^" + (num_length-1));
        temp = temp * Math.pow(base, num_length-1);
        work2 = work2.concat(temp);
        decimal += temp;
        i++;
        num_length--;
        if(num_length>0){
          work1 = work1.concat("+");
          work2 = work2.concat("+");
        }
      }
      res = res + decimal.toString();
      
      if(radix.length==2){
        var fraction = 0;
        res = res.concat(".");
        var frac_len = radix[1].length;
        for(let i = 0; i<frac_len; i++){
          temp = getValueAt(radix[1], i, log);
          work1 = work1.concat(" + " + temp + "*" + base + "^(-" + (i+1) + ")");
          work2 = work2.concat(" + " + temp + "/" + Math.pow(base, i+1));
          fraction += (Math.floor(temp * PRECISION_NUMBER / Math.pow(base, i+1)));
        } 
        res = res.concat(fraction.toString());
      }
      addToOutput(work1 + " = ");
      addToOutput(work2 + " = ");
      addToOutput("(" + res + ")10");
      return trimNumber(res);
    }

    function fromDecimal(number, base, standardized=false, log=true){
      if(!isValidBase(base)){
        addToStackTrace("fromDecimal", "Invalid base \"" + base + "\"", log);
        return null;
      }
      if(!standardized){
        number = standardizeNumber(number, 10, log);
        if(number == null){
          addToStackTrace("fromDecimal", "Invalid number \"" + number + "\" for base 10", log);
          return null;
        }
      }
      if(base==10){
        return number;
      }
      
      var res = getSign(number, true);
      var num_arr = [];

      var radix = number.split(/[.,]/);

      var work1 = "";
      var work2 = "";

      var whole = baseToDecimalInteger(radix[0], 10);
      if(whole<0){
        whole = -whole;
      }
      while(whole>0){
        work1 = work1.concat("<td>" + Math.floor(whole/base) + "</td>");
        work2 = work2.concat("<td>" + (whole%base) + "</td>");
        num_arr.push(toValue(whole%base));
        whole = Math.floor(whole/base);
      }
      num_arr.reverse();
      for(var i = 0; i<num_arr.length; i++){
        res = res.concat(num_arr[i]);
      }
      addToOutput("<table>");
      addToOutput("<tr>");
      addToOutput(work1);
      addToOutput("</tr>");
      addToOutput("<tr>");
      addToOutput(work2);
      addToOutput("</tr>");
      addToOutput("</table>");

      if(radix.length==2){
        radix[1] = addZeroesAfter(radix[1], PRECISION);
        var frac = baseToDecimalInteger(radix[1], 10);
        res = res.concat(".");
        var limit = 0;
        var temp = 0;
        work1 = "<td>" + trimNumber("0."+frac.toString()) + "</td>";
        work2 = "<td>" + temp + "</td>";
        while(frac>0 && limit<PRECISION){
          frac = frac*base;
          temp = Math.floor(frac/PRECISION_NUMBER);
          frac -= temp*PRECISION_NUMBER;
          work1 = work1.concat("<td>" + trimNumber("0."+frac.toString()) + "</td>");
          work2 = work2.concat("<td>" + toValue(temp) + "</td>");
          res = res.concat(toValue(temp));
          limit++;
        }
      }
      addToOutput("<table>");
      addToOutput("<tr>");
      addToOutput(work1);
      addToOutput("</tr>");
      addToOutput("<tr>");
      addToOutput(work2);
      addToOutput("</tr>");
      addToOutput("</table>");

      return res;
    }

    function convertBases(number, base_from, base_to, standardized=false, log=true){
      if(!isValidBase(base_from) || !isValidBase(base_to)){
        addToStackTrace("convertBases", "Invalid bases \"" + base_from + "\" and \"" + base_to + "\"", log);
        return null;
      }
      var std_val;
      if(!standardized){
        std_val = standardizeNumber(number, base_from, log);
        if(std_val==null){
          addToStackTrace("convertBases", "Invalid number \"" + number + "\" for base \"" + base_from + "\"", log);
          return null;
        }
      }else{
        std_val = number;
      }
      if(base_from==base_to){
        return std_val;
      }
      var res = fromDecimal(toDecimal(std_val, base_from, true), base_to, true);
      if(res==null){
        addToStackTrace("convertBases", "Conversion error, result null", log);
      }
      addToOutput(res);
      return res;
    }

    function test(){
      runTests();
    }
  </script>
</head>
<body>

  <div class="container" id="main">

    <p>Pretvoriti broj: </p>
    <input type="text" id="input"></input>
    <p>Iz sistema: </p>
    <input type="number" id="base_src"></input>
    <p>U sistem: </p>
    <input type="number" id="base_dest"></input>
    <br><br>
    <input value="Izracunaj" type="button" name="calc" id="calc" onclick="calculate()"></input>

    <p id="text1">
      resenje
    </p>

    <input value="Test" type="button" name="test" id="test" onclick="test()"></input>


  </div>

</body>
</html>
